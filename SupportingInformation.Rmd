---
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    toc: no
    number_sections: false
    keep_tex: true
    includes:
      in_header: "sipreamble.tex"
    extra_dependencies: ["float"]
bibliography: "references.bib"
title: Supporting Information for 
author:
  - Aaron P. Ragsdale^[aaronpeaceragsdale@gmail.com]
date:
  - \today
---

```{r sisetup, echo=F}
options(tinytex.clean = FALSE)
```

# Supporting Information

\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}
\renewcommand{\theequation}{S\arabic{equation}}
\setcounter{figure}{0}
\setcounter{table}{0}
\setcounter{equation}{0}

## The diffusion equation and moment system for the two-locus sampling distribution

The two-locus diffusion equation with additive selection was first described by
@Kimura1955-qe studied extensively in the 1960s and 70s, including by
@Hill1966-gv and @Ohta1969-ie. The continuous distribution $\psi(x_1, x_2,
x_3)$ of haplotype frequencies in a population, where $x_1$ is the frequency of
$AB$, $x_2$ of $Ab$, and $x_3$ of $aB$, is governed by the multi-dimensional
Fokker-Planck equation:
\begin{align} \label{eq:diffeq}
\frac{\partial \psi}{\partial \tau} = &
\frac{1}{2}\mathop{\sum\sum}_{1\leq i, j \leq 3} 
\frac{\partial^2}{\partial x_i \partial x_j} 
\left[\frac{x_i(\delta_{i=j}-x_j)\psi}{\nu(\tau)}\right] \\\nonumber
& -\frac{\rho}{2}\left(-\frac{\partial}{\partial x_1} D\psi
  + \frac{\partial}{\partial x_2} D\psi
  + \frac{\partial}{\partial x_3} D\psi\right) \\\nonumber
& - \frac{\gamma_A}{2}\left[
  \frac{\partial}{\partial x_1} x_1(1-x_1-x_2)\psi
  + \frac{\partial}{\partial x_2} x_2(1-x_1-x_2)\psi
  - \frac{\partial}{\partial x_3} x_3(x_1+x_2)\psi
  \right] \\\nonumber
& -\frac{\gamma_B}{2}\left[
  \frac{\partial}{\partial x_1} x_1(1-x_1-x_3)\psi
  - \frac{\partial}{\partial x_2} x_2(x_1+x_3)\psi
  + \frac{\partial}{\partial x_3} x_3(1-x_1-x_3)\psi
  \right].
\end{align}
$D$ is the standard covariance measure of linkage disequilibrium, \[D=x_1 -
(x_1+x_2)(x_1+x_3) = x_1 x_4 - x_2 x_3,\] $\gamma_A$ and $\gamma_B$ are the
scaled selection coefficients at the left and right locus, and $\rho$ is the
scaled recombination rate between the two loci. Time $\tau$ is measured in
$2N_e$ generations.

Given a function $\psi$ that solves Equation \ref{eq:diffeq}, the two-locus
sampling distribution for a sample size of $n$ haploids can be found by
integrating $\Psi$ against the multinomial sampling function, so that
\begin{align} \label{eq:multinomial}
\Psi_n(i, j, k) =
{n \choose{i, j, k, n-i-j-k}}
\mathop{\mathop{\int\int\int}_{x_1, x_2, x_3 \geq0}}_{x_1+x_2+x_3\leq1}
\psi(x_1, x_2, x_3) x_1^i x_2^j x_3^k (1-x_1-x_2-x_3)^{n-i-j-k}
dx_1 dx_2 dx_3.
\end{align}

- instead of (numerically) solving for $\psi$ and using \@ref(eq:multinomial},
  we can apply the multinomial sampling formula directly to the PDE
- what we get instead is a system of differential equations on the entries of
  $\Psi_n$
- we can then solve for these noncanonical moments of $\psi$, which are the
  objects of interest in any case, and avoid having to solve this numerical PDE
  with unpleasant boundary conditions
- the same system can be found by deriving recursion from considering tracking
  $n$ lineages within the population, in the vein of @Wright1931-xx

### Drift, mutation, recombination, and moment closure

- point to supplement of @Ragsdale2019-nt

### Selection

## Data analysis

### DFE for missense and LOF variants

Loss-of-function (LOF) variants show a dramatic skew toward low-frequency
variants across all human populations (Table \@ref(tab:tajimasD)). Here, using
the folded SFS for synonymous, missense, and LOF mutations across all autosomal
genes, I infer DFEs for missense and LOF mutations independently. I consider a
few different dominance coefficients to explore the effect of the assumed
recessivity of the two classes of mutations.

The standard SFS approach to fitting the DFE involves first inferring a
demographic history for the population using putatively neutral variants (here,
synonymous mutations), and then fixing that demography and fitting a
parameterized function for the distribution of selection coefficients for new
mutations for the selected classes. DFE inference also requires an estimate for
the total mutation rate of the different mutation classes, as much of the
signal for strongly selected mutations comes from observing fewer mutations
than expected given a known mutation rate (with the assumption that selection
purges some fraction of strongly deleterious mutations which are unseen in the
sample). Here, I fit demography and DFEs to the SFS from the Mende in Sierra
Leone (MSL) using *moments* [@Jouganous2017-pq].

I used the mutation model from @Karczewski2020-le to estimate the total
mutation rate across autosomal genes ($uL$, where $u$ is the per-base mutation
rate, and $L$ is the total length of the coding genome). These values were
$(0.1442, 0.3426, 0.0256)$ for synonymous, missense, and LOF mutations,
respectively. Roughly two thirds of new mutations in coding regions are
expected to be missense mutations, while only 5\% of new mutations are LOF. I
fit a demographic model to the synonymous variants, which included a population
expansion in the deeper past and exponential growth in the recent past (Figure
\@ref(fig:msldfe)A). Using the inferred optimal scaled mutation rate,
$\theta=4N_euL$, I estimated $Ne\approx12,300$, and assuming an average
generation time of 29 years I converted the inferred genetic units to physical
units. The best-fit model had a roughly two-fold expansion 400 thousand years
ago, and then exponential growth over the past 20-30 thousand years, with a
current effective size of $\sim 63,000$.

Under this demographic model, I fit a gamma distribution for the distribution
of fitness effects to missense and LOF mutations (Table \@ref(tab:msldfe)). For
each fit, I fixed the scaled mutation rate for each mutation class, so that
$\theta_{mis} = \frac{u_{mis}}{u_{syn}} \hat\theta_{syn}$ and $\theta_{lof} =
\frac{u_{lof}}{u_{syn}} \hat\theta_{syn}$, where values of $u$ were found using
the GNOMAD mutation model [@Karczewski2020-le]. I tested three values for the
dominance coefficient $h$, $0$, $0.2$ and $0.5$. For missense mutations, $h=0$
gave a poor fit to the data, and $h=0.5$ fit best among the three tested
dominance coefficients. For LOF variants, $h=0$ also fit poorly, but $h=0.2$
and $h=0.5$ gave similar likelihoods, highlighting that inferring dominance
using the SFS is poorly constrained. Regardless of the dominance coefficient
assumed, however, the vast majority of LOF variants were inferred to be
strongly deleterious, with only $\sim10\%$ of new mutations having selection
coefficients on the order $1/N_e$ or less.

### Multinucleotide mutations and positive LD between linked synonymous variants

Multinucleotide mutations (MNMs) are complex mutational events that result in
multiple mutations occurring on the same haplotype background in a single
generation. Because MNMs fall on the same haplotype, those mutations will be in
positive LD, and LD between those pairs that are very tightly linked will not
be broken down all that rapidly. MNMs are expected to occur over relatively short
distances, on the order of 10s or 100s of base pairs, making them a likely culprit
of the observed positive LD among synonymous mutations at short distances.

Multinucleotide mutations can be easily incorporated into the moment system with
a simple adjustment to the mutation operator. Instead of all mutations occurring
independently in haplotypes with mutations already segregating at the other locus,
some fraction of new mutations could instead occur spontaneously and create a new
pair of mutations with initial counts $n_{AB} = 1$ and $n_{ab} = n-1$.

Here, I fit a simple exponential model for the fraction of new mutations at a
given distance that arose through a MNM event, so that $P(MNM | d) =
Ae^{-\lambda d}$, where $d$ is the distance separating pairs of mutations. I
considered all synonymous mutations within genes in the MSL population and used
the same population size history model as inferred in the DFE section above for
a demographic control. This left two parameters to be fit, $A$ and $\lambda$,
which I fit to the binned decay curve of $\sigma_d^1$. I needed to assume an
average per-base recombination rate $r$ across gene regions, and tested a
number of values between $10^{-9}$ and $2\times 10^{-8}$. The optimization was
insensitive to the chosen value or $r$, because the decay of positive LD occurs
rapidly. For any plausible value of $r$, the $\sigma_d^1$ decays to zero well
before distances between pairs have scaled recombination rates $\rho=4 N_e r
d$, and expected statistics for $\rho \ll 1$ vary only negligibly.

In fitting the LD decay of $\sigma_d^1$, the best fit parameters were
$A=0.132$, and $\lambda=0.0103$. An exponential scaling of $0.01$ implies that
the vast majority of new mutations do not occur via MNMs for distances greater
than 200 bp, though a substantial fraction ($10-15\%$) occur via MNMs for very
tightly linked loci with distances on the order $0-50$ base pairs. It is
important to note that this does not mean that $10-15\%$ of new mutations occur
via MNMs, since this fraction is contitioned on two mutations occurring at
short distances.

### Grouping Thousand Genomes populations based on clustering

Testing grouping populations that cluster together as a single population.

- Does not reduce CIs

Citation for Alex's work:
\url{https://www.abstractsonline.com/pp8/#!/9070/presentation/2384}

\clearpage
\newpage

# Supplementary Tables

```{r selmodels, echo=F, tab.align="center"}
library(knitr)
library(kableExtra)
pops <- read.csv("tables/sel_models.txt", sep=";", header=TRUE, check.names=FALSE)
knitr::kable(pops, "latex", booktabs=T, escape=F,
    caption="General selection model for diploids and dominance models.") %>%
kable_styling(latex_options = "HOLD_position")
```

```{r epistasis, echo=F, tab.align="center"}
library(knitr)
library(kableExtra)
pops <- read.csv("tables/epistasis_model.txt", sep=";", header=TRUE, check.names=FALSE)
knitr::kable(pops, "latex", booktabs=T, escape=F,
    caption="Haploid epistasis model.") %>%
kable_styling(latex_options = "HOLD_position")
```

```{r 1kgpops, echo=F, tab.align="center"}
library(knitr)
library(kableExtra)
pops <- read.csv("tables/populations.txt", sep=";", header=TRUE, check.names=FALSE)
knitr::kable(pops, "latex", booktabs=T,
    caption="Thousand Genomes Project population descriptions for populations used in this study.") %>%
kable_styling(latex_options = "HOLD_position")
```

```{r tajimasD, echo=F, tab.align="center"}
library(knitr)
library(kableExtra)
taj <- read.csv("tables/tajimas_d.txt", sep=";", header=TRUE, check.names=FALSE)
knitr::kable(taj, "latex", booktabs=T, longtable=T,
    linesep = c("", "", "", "", "", "", "", "", "\\addlinespace"),
    caption="Tamija's $D$ for classes of coding mutations, both within annotated domains and outside of domains.") %>%
kable_styling(latex_options = c("HOLD_position", "repeat_header"))
```

```{r msldfe, echo=F, tab.align="center"}
library(knitr)
library(kableExtra)
dfes <- read.csv("tables/msl_dfes.txt", sep=";", header=TRUE, check.names=FALSE)
knitr::kable(dfes, "latex", booktabs=T, escape=FALSE,
    linesep = c("", "", "\\addlinespace"),
    caption="DFEs inferred for missense and loss-of-function variants in MSL for varying values of $h$. General patterns are consistent across different chosen values of $h$, although for $h=0$ results in poorer fits for both missense and LOF variants. Columns to the right of the log-likelihood (LL) column show proportions of new mutations with $|s|$ in each given bin.") %>%
kable_styling(latex_options = c("HOLD_position", "repeat_header"))
```






\clearpage
\newpage

# Supplementary Figures

```{r jackknife, echo=F, fig.cap="(ref:figjackknife)", fig.align="center"}
knitr::include_graphics("figures/jackknife.pdf")
```

(ref:figjackknife) **Accuracy of the jackknife approximation and runtime**
Small sample sizes can lead to large error in the closure approximation for
larger recombination distances or selection coefficients. Generally, the
jackknife approximation breaks down for recombination rates greater than
$\rho\approx30$. While increasing sample size leads to more accurate solutions,
it comes at the cost of both increased runtime and memory usage. Most analyses
performed in this paper used $n$ between 40 and 70.


```{r genespops, echo=F, fig.cap="(ref:figgenespopscap)", fig.align="center"}
knitr::include_graphics("figures/supp_gene_wide_all_pops.pdf")
```

(ref:figgenespopscap) **LD within and between protein-coding genes.**


```{r domainspops, echo=F, fig.cap="(ref:figdomainspopscap)", fig.align="center"}
knitr::include_graphics("figures/supp_domain_all_pops.pdf")
```

(ref:figdomainspopscap) **LD within and between coding domains and pairs
outside domains at matched distances.**


```{r lddecaydomain, echo=F, fig.cap="(ref:figlddecaydomain)", fig.align="center"}
knitr::include_graphics("figures/supp_ld_decay_in_domain.pdf")
```

(ref:figlddecaydomain) **LD decay for synonymous and missense mutations for pairs
of mutations that fall inside the same domains.** 


```{r lddecay, echo=F, fig.cap="(ref:figlddecay)", fig.align="center"}
knitr::include_graphics("figures/supp_ld_decay.pdf")
```

(ref:figlddecay) **LD decay for synonymous and missense mutations for pairs
of mutations that fall outside of domains.** 


```{r msldemogdfe, echo=F, fig.cap="(ref:figmsldfe)", fig.align="center"}
knitr::include_graphics("figures/msl_demography_dfes.pdf")
```

(ref:figmsldfe) **Demography and DFE for MSL.** A demographic model was fit to
the folded synonymous SFS, and DFEs were fit to missense and loss-of-function
SFS. Shown here are DFEs fit with $h=0.5$.


```{r mslmnms, echo=F, fig.cap="(ref:figmslmnm)", fig.align="center"}
knitr::include_graphics("figures/msl_mnms.pdf")
```

(ref:figmslmnm) **Optimization of fraction of new mutations arising via
multinucleotide mutations by distance.** A simple exponential function was fit
to describe the probability that a pair of mutations arose through a MSM event
at a given distance $d$, as $Ae^{-\lambda d}$. Across all recombination rates
tested, the best fit parameters were $A=0.13$ and $\lambda=0.010$.



\clearpage
\newpage

# Supporting References
